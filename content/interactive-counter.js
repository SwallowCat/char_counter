// content/interactive-counter.js - „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç´„Ç¶„É≥„Çø„Éº„ÅÆ„É°„Ç§„É≥Ê©üËÉΩ
(function(global) {
    'use strict';
    console.log('üîß interactive-counter.js module executing...');
    
    let interactiveCounterElement = null;
    let currentSettings = { openMode: 'window' };
    
    // „Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„Ç´„Ç¶„É≥„Çø„Éº„Çí„Éö„Éº„Ç∏„Å´Ë°®Á§∫
    async function showInteractiveCounterOnPage(initialText = '') {
        console.log('üéÆ showInteractiveCounterOnPage called with initialText:', initialText.substring(0, 50));
        
        try {
            // ‰æùÂ≠òÈñ¢Êï∞„ÅÆÁ¢∫Ë™ç
            if (!global.removeInteractiveCounter || !global.loadSettings || !global.loadInteractiveCounterTemplate || !global.showInteractiveCounter || !global.handleTextChange) {
                console.error('‚ùå Required dependencies not available:', {
                    removeInteractiveCounter: !!global.removeInteractiveCounter,
                    loadSettings: !!global.loadSettings,
                    loadInteractiveCounterTemplate: !!global.loadInteractiveCounterTemplate,
                    showInteractiveCounter: !!global.showInteractiveCounter,
                    handleTextChange: !!global.handleTextChange
                });
                throw new Error('Required dependencies not available');
            }
            
            // Êó¢Â≠ò„ÅÆ„Ç´„Ç¶„É≥„Çø„Éº„ÇíÂâäÈô§
            global.removeInteractiveCounter();
            
            // Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
            currentSettings = await global.loadSettings();
            console.log('üìã Loaded settings:', currentSettings);
            
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø
            const html = await global.loadInteractiveCounterTemplate(initialText);
            
            // „Ç´„Ç¶„É≥„Çø„Éº„ÇíË°®Á§∫
            interactiveCounterElement = global.showInteractiveCounter(html);
            
            if (interactiveCounterElement) {
                console.log('‚úÖ Interactive counter created successfully');
                
                // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÇíË®≠ÂÆö
                setupInteractiveCounterEvents();
                
                // ÂàùÊúü„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
                global.handleTextChange(interactiveCounterElement);
                
                // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„Å´„Éï„Ç©„Éº„Ç´„Çπ
                const textarea = interactiveCounterElement.querySelector('#textArea');
                if (textarea) {
                    textarea.focus();
                }
                
                console.log('üéØ Interactive counter setup completed');
            } else {
                console.error('‚ùå Failed to create interactive counter element');
            }
        } catch (error) {
            console.error('‚ùå Error in showInteractiveCounterOnPage:', error);
            throw error;
        }
    }
    
    // „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº„ÅÆË®≠ÂÆö
    function setupInteractiveCounterEvents() {
        if (!interactiveCounterElement) {
            console.error('‚ùå No interactive counter element found for event setup');
            return;
        }
        
        // DOMË¶ÅÁ¥†„ÇíÂèñÂæó
        const inputTextarea = interactiveCounterElement.querySelector('#textArea');
        const clearBtn = interactiveCounterElement.querySelector('#clearButton');
        const copyBtn = interactiveCounterElement.querySelector('#copyButton');
        const pasteBtn = interactiveCounterElement.querySelector('#pasteButton');
        const saveBtn = interactiveCounterElement.querySelector('#saveButton');
        const closeBtn = interactiveCounterElement.querySelector('#closeButton');
        const historyToggle = interactiveCounterElement.querySelector('#historyToggle');
        const historySection = interactiveCounterElement.querySelector('#historySection');
        const historyList = interactiveCounterElement.querySelector('#historyList');
        const clearHistoryBtn = interactiveCounterElement.querySelector('#clearHistoryButton');
        const settingsToggle = interactiveCounterElement.querySelector('#settingsToggle');
        const settingsSection = interactiveCounterElement.querySelector('#settingsSection');
        const openModeSelect = interactiveCounterElement.querySelector('#openModeSelect');
        
        // „ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà
        if (inputTextarea) {
            inputTextarea.addEventListener('input', () => {
                global.handleTextChange(interactiveCounterElement);
            });
            console.log('‚úÖ Text area event listener added');
        }
        
        // „ÇØ„É™„Ç¢„Éú„Çø„É≥
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                if (inputTextarea) {
                    inputTextarea.value = '';
                    global.handleTextChange(interactiveCounterElement);
                    inputTextarea.focus();
                }
            });
        }
        
        // „Ç≥„Éî„Éº„Éú„Çø„É≥
        if (copyBtn) {
            copyBtn.addEventListener('click', async () => {
                if (inputTextarea) {
                    const success = await global.handleCopyText(inputTextarea.value);
                    if (success) {
                        copyBtn.textContent = '‚úì';
                        setTimeout(() => copyBtn.textContent = '„Ç≥„Éî„Éº', 1000);
                    }
                }
            });
        }
        
        // Ë≤º„Çä‰ªò„Åë„Éú„Çø„É≥
        if (pasteBtn) {
            pasteBtn.addEventListener('click', async () => {
                if (inputTextarea) {
                    const text = await global.handlePasteText();
                    if (text) {
                        inputTextarea.value = text;
                        global.handleTextChange(interactiveCounterElement);
                        inputTextarea.focus();
                    }
                }
            });
        }
        
        // ‰øùÂ≠ò„Éú„Çø„É≥
        if (saveBtn) {
            saveBtn.addEventListener('click', async () => {
                if (inputTextarea && inputTextarea.value.trim()) {
                    const success = await global.saveToHistory(inputTextarea.value);
                    if (success) {
                        saveBtn.textContent = '‚úì';
                        setTimeout(() => saveBtn.textContent = '‰øùÂ≠ò', 1000);
                        // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
                        await updateHistoryList();
                    }
                }
            });
        }
        
        // Èñâ„Åò„Çã„Éú„Çø„É≥
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                global.removeInteractiveCounter();
                interactiveCounterElement = null;
            });
        }
        
        // Â±•Ê≠¥Ë°®Á§∫Âàá„ÇäÊõø„Åà
        if (historyToggle && historySection) {
            historyToggle.addEventListener('click', async () => {
                const isVisible = historySection.style.display !== 'none';
                if (isVisible) {
                    historySection.style.display = 'none';
                    historyToggle.textContent = 'Â±•Ê≠¥„ÇíË°®Á§∫ ‚ñº';
                } else {
                    historySection.style.display = 'block';
                    historyToggle.textContent = 'Â±•Ê≠¥„ÇíÈùûË°®Á§∫ ‚ñ≤';
                    await updateHistoryList();
                }
            });
        }
        
        // Â±•Ê≠¥„ÇØ„É™„Ç¢„Éú„Çø„É≥
        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', async () => {
                if (confirm('Â±•Ê≠¥„Çí„Åô„Åπ„Å¶ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
                    await chrome.runtime.sendMessage({ 
                        action: 'saveHistory', 
                        history: [] 
                    });
                    await updateHistoryList();
                }
            });
        }
        
        // Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        if (historyList) {
            historyList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-history-item')) {
                    // ÂâäÈô§„Éú„Çø„É≥„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà
                    const itemId = e.target.dataset.id;
                    await deleteHistoryItem(itemId);
                    await updateHistoryList();
                    e.stopPropagation();
                } else if (e.target.closest('.history-item')) {
                    // Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà
                    const historyItem = e.target.closest('.history-item');
                    const itemId = historyItem.dataset.id;
                    const history = await global.loadHistory();
                    const item = history.find(h => h.id === itemId);
                    if (item && inputTextarea) {
                        inputTextarea.value = item.text;
                        global.handleTextChange(interactiveCounterElement);
                        inputTextarea.focus();
                    }
                }
            });
        }
        
        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´Ë°®Á§∫Âàá„ÇäÊõø„Åà
        if (settingsToggle) {
            settingsToggle.addEventListener('click', async () => {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'block';
                    
                    // ÁèæÂú®„ÅÆË®≠ÂÆö„ÇíË°®Á§∫
                    const popupMode = document.getElementById('popupMode');
                    const windowMode = document.getElementById('windowMode');
                    const tabMode = document.getElementById('tabMode');
                    
                    if (popupMode && windowMode && tabMode) {
                        popupMode.checked = currentSettings.openMode === 'popup';
                        windowMode.checked = currentSettings.openMode === 'window';
                        tabMode.checked = currentSettings.openMode === 'tab';
                    }
                }
            });
        }
        
        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆÈñâ„Åò„Çã„Éú„Çø„É≥
        const closeModal = document.getElementById('closeModal');
        if (closeModal) {
            closeModal.addEventListener('click', () => {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });
        }
        
        // Ë®≠ÂÆö‰øùÂ≠ò„Éú„Çø„É≥
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        if (saveSettingsBtn) {
            saveSettingsBtn.addEventListener('click', async () => {
                const popupMode = document.getElementById('popupMode');
                const windowMode = document.getElementById('windowMode');
                const tabMode = document.getElementById('tabMode');
                
                let openMode = 'window'; // „Éá„Éï„Ç©„É´„Éà
                if (popupMode && popupMode.checked) openMode = 'popup';
                else if (windowMode && windowMode.checked) openMode = 'window';
                else if (tabMode && tabMode.checked) openMode = 'tab';
                
                const newSettings = { openMode };
                
                const success = await global.saveSettings(newSettings);
                if (success) {
                    currentSettings = newSettings;
                    
                    // „Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„Çπ„ÇØ„É™„Éó„Éà„Å´Ë®≠ÂÆöÊõ¥Êñ∞„ÇíÈÄöÁü•
                    try {
                        await chrome.runtime.sendMessage({
                            action: 'updateSettings',
                            settings: newSettings
                        });
                        console.log('‚úÖ Settings updated in background script');
                    } catch (error) {
                        console.error('‚ùå Failed to update settings in background script:', error);
                    }
                    
                    saveSettingsBtn.textContent = '‚úì';
                    setTimeout(() => {
                        saveSettingsBtn.textContent = '‰øùÂ≠ò';
                        const settingsModal = document.getElementById('settingsModal');
                        if (settingsModal) {
                            settingsModal.style.display = 'none';
                        }
                    }, 1000);
                }
            });
        }
        
        // Ë®≠ÂÆö„Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥
        const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');
        if (cancelSettingsBtn) {
            cancelSettingsBtn.addEventListener('click', () => {
                const settingsModal = document.getElementById('settingsModal');
                if (settingsModal) {
                    settingsModal.style.display = 'none';
                }
                
                // ÂÖÉ„ÅÆË®≠ÂÆö„Å´Êàª„ÅôÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ
                const popupMode = document.getElementById('popupMode');
                const windowMode = document.getElementById('windowMode');
                const tabMode = document.getElementById('tabMode');
                
                if (popupMode && windowMode && tabMode) {
                    popupMode.checked = currentSettings.openMode === 'popup';
                    windowMode.checked = currentSettings.openMode === 'window';
                    tabMode.checked = currentSettings.openMode === 'tab';
                }
            });
        }
        
        console.log('‚úÖ All event handlers set up successfully');
    }
    
    // Â±•Ê≠¥„É™„Çπ„Éà„ÅÆÊõ¥Êñ∞
    async function updateHistoryList() {
        const history = await global.loadHistory();
        global.updateHistoryDisplay(interactiveCounterElement, history);
    }
    
    // Â±•Ê≠¥„Ç¢„Ç§„ÉÜ„É†„ÅÆÂâäÈô§
    async function deleteHistoryItem(itemId) {
        const history = await global.loadHistory();
        const filteredHistory = history.filter(item => item.id !== itemId);
        await chrome.runtime.sendMessage({ 
            action: 'saveHistory', 
            history: filteredHistory 
        });
    }
    
    // „Ç∞„É≠„Éº„Éê„É´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Å´Èñ¢Êï∞„ÇíÁôªÈå≤
    global.showInteractiveCounterOnPage = showInteractiveCounterOnPage;
    global.setupInteractiveCounterEvents = setupInteractiveCounterEvents;
    
    console.log('‚úÖ interactive-counter.js functions registered:', ['showInteractiveCounterOnPage', 'setupInteractiveCounterEvents']);
    console.log('üîç showInteractiveCounterOnPage available:', typeof global.showInteractiveCounterOnPage === 'function');
    
    // Èñ¢Êï∞„ÅÆÁôªÈå≤„ÇíÁ¢∫ÂÆü„Å´„Åô„Çã„Åü„ÇÅ„Å´Â∞ë„ÅóÈÅÖÂª∂Âæå„Å´ÂÜçÁ¢∫Ë™ç
    setTimeout(() => {
        console.log('üîç Double-check - showInteractiveCounterOnPage available:', typeof global.showInteractiveCounterOnPage === 'function');
        console.log('üîç All registered functions:', Object.keys(global));
    }, 10);
    
})(window.CounterExtension = window.CounterExtension || {});
